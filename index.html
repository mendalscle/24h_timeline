<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>1日の時間割タイムライン</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #timeline { border: 1px solid #ccc; }
    /* 日付ラベル（曜日・月など）を非表示にする */
    .vis-time-axis .vis-text.vis-major {
      display: none !important;
    }
    
    /* アイテム上の線と丸を非表示にする */
    .vis-item .vis-item-overflow {
      overflow: hidden;
    }
    .vis-item .vis-item-content {
      position: relative;
    }
    .vis-item .vis-onUpdateTime-tooltip,
    .vis-item .vis-drag-center {
      display: none !important;
    }
    .vis-item.vis-range .vis-item-content::before,
    .vis-item.vis-range .vis-item-content::after {
      display: none !important;
    }
    
    /* アイテム縦幅を統一 */
    .vis-item {
      height: 30px !important;
      min-height: 30px !important;
    }
    .vis-item .vis-item-content {
      height: 30px !important;
      line-height: 30px !important;
      padding: 0 8px !important;
      box-sizing: border-box !important;
    }

    .vis-item .vis-delete {
      right: -28px;
    }


    /* テキストボックス追加フォーム */
    .add-item-box {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    .add-item-box h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .input-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 3px;
      min-width: 200px;
    }
    .input-row button {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 3px;
      cursor: pointer;
    }
    .input-row button:hover:not(:disabled) {
      background: #218838;
    }
    .input-row button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .input-row button.cancel {
      background: #dc3545;
    }
    .input-row button.cancel:hover:not(:disabled) {
      background: #c82333;
    }
    
    /* モーダルダイアログのスタイル */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 300px;
      border-radius: 5px;
    }
    .modal-buttons {
      text-align: right;
      margin-top: 15px;
    }
    .modal-buttons button {
      margin-left: 10px;
      padding: 5px 15px;
      cursor: pointer;
    }
    #itemNameInput {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    /* 現在時刻ラインのドラッグを無効化 */
    .vis-custom-time.currentTime {
      pointer-events: none !important;
      cursor: default !important;
      z-index: 1 !important;
    }
  </style>
</head>
<body>
  <h2>1日の時間割（ドラッグで変更可能）</h2>
  <div id="timeline"></div>

  <!-- アイテム追加テキストボックス -->
  <div class="add-item-box">
    <h3>新しいアイテムを追加</h3>
    <div class="input-row">
      <input type="text" id="newItemInput" placeholder="アイテム名を入力してください（タイムライン上をダブルクリックしてください）" disabled>
      <button id="addItemBtn" onclick="createNewItem()" disabled>追加</button>
      <button id="cancelBtn" onclick="cancelNewItem()" class="cancel" disabled>キャンセル</button>
    </div>
  </div>

  <!-- モーダルダイアログ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">アイテム名を入力してください</h3>
      <input type="text" id="itemNameInput" placeholder="アイテム名">
      <div class="modal-buttons">
        <button onclick="cancelModal()">キャンセル</button>
        <button onclick="confirmModal()">OK</button>
      </div>
    </div>
  </div>

  <script>
    // 新規アイテム作成用の変数
    let pendingItem = null;

    // テキストボックスでの新規アイテム作成機能
    function startNewItemCreation(clickTime) {
      // 開始時間を15分単位に調整
      const startTime = new Date(clickTime);
      const snapStart = Math.round(startTime.getTime() / (15 * 60 * 1000)) * (15 * 60 * 1000);
      const snappedStartTime = new Date(snapStart);
      
      // 開始時間から1時間後を終了時間に設定
      const endTime = new Date(snappedStartTime.getTime() + 60 * 60 * 1000);
      
      // 保留中のアイテム情報を保存
      pendingItem = {
        start: snappedStartTime.toISOString(),
        end: endTime.toISOString()
      };
      
      // テキストボックスを有効化してフォーカス
      const input = document.getElementById('newItemInput');
      const addBtn = document.getElementById('addItemBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      
      input.disabled = false;
      input.placeholder = "アイテム名を入力してください";
      input.value = "";
      input.focus();
      
      addBtn.disabled = false;
      cancelBtn.disabled = false;
      
      console.log('新規アイテム作成開始:', pendingItem);
    }
    
    function createNewItem() {
      if (!pendingItem) return;
      
      const input = document.getElementById('newItemInput');
      const name = input.value.trim();
      
      if (!name) {
        alert('アイテム名を入力してください');
        input.focus();
        return;
      }
      
      // 新しいアイテムを作成
      const newItem = {
        id: Date.now(),
        content: name,
        start: pendingItem.start,
        end: pendingItem.end,
        editable: { updateTime: true, remove: true }
      };
      
      // タイムラインに追加
      items.add(newItem);
      saveItem(newItem);
      
      // リセット
      resetNewItemForm();
      
      console.log('新しいアイテムを作成しました:', newItem);
    }
    
    function cancelNewItem() {
      resetNewItemForm();
    }
    
    function resetNewItemForm() {
      const input = document.getElementById('newItemInput');
      const addBtn = document.getElementById('addItemBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      
      input.disabled = true;
      input.placeholder = "アイテム名を入力してください（タイムライン上をダブルクリックしてください）";
      input.value = "";
      
      addBtn.disabled = true;
      cancelBtn.disabled = true;
      
      pendingItem = null;
    }
    
    // Enterキーで追加、Escapeキーでキャンセル
    document.getElementById('newItemInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !this.disabled) {
        // IMEによる変換中の場合は処理しない
        if (e.isComposing || e.keyCode === 229) {
          return;
        }
        createNewItem();
      } else if (e.key === 'Escape' && !this.disabled) {
        cancelNewItem();
      }
    });

    // モーダルダイアログの制御
    let currentModalCallback = null;
    
    function showModal(title, defaultValue, callback) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('itemNameInput').value = defaultValue || '';
      document.getElementById('modal').style.display = 'block';
      document.getElementById('itemNameInput').focus();
      currentModalCallback = callback;
    }
    
    function hideModal() {
      document.getElementById('modal').style.display = 'none';
      currentModalCallback = null;
    }
    
    function confirmModal() {
      const value = document.getElementById('itemNameInput').value.trim();
      if (currentModalCallback) {
        currentModalCallback(value || null);
      }
      hideModal();
    }
    
    function cancelModal() {
      if (currentModalCallback) {
        currentModalCallback(null);
      }
      hideModal();
    }
    
    // Enterキーでも確定できるように
    document.getElementById('itemNameInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        confirmModal();
      } else if (e.key === 'Escape') {
        cancelModal();
      }
    });

    // 固定のダミー日付（どの日でもOK。時間だけ使う）
    const baseDate = "1970-01-01";

    // データベース初期化
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('timelineDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('items')) {
            db.createObjectStore('items', { keyPath: 'id' });
          }
        };
        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
      });
    }

    // 保存
    async function saveItem(item) {
      try {
        const db = await openDB();
        const tx = db.transaction('items', 'readwrite');
        const store = tx.objectStore('items');
        store.put(item);
        await new Promise((resolve, reject) => {
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
        console.log('アイテムを保存しました:', item);
      } catch (error) {
        console.error('保存に失敗しました:', error);
      }
    }

    // 削除
    async function deleteItem(id) {
      try {
        const db = await openDB();
        const tx = db.transaction('items', 'readwrite');
        const store = tx.objectStore('items');
        store.delete(id);
        await new Promise((resolve, reject) => {
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
        console.log('アイテムを削除しました:', id);
      } catch (error) {
        console.error('削除に失敗しました:', error);
      }
    }

    // 取得
    async function loadItems() {
      try {
        const db = await openDB();
        const tx = db.transaction('items', 'readonly');
        const store = tx.objectStore('items');
        return new Promise((resolve, reject) => {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      } catch (error) {
        console.error('読み込みに失敗しました:', error);
        return [];
      }
    }

    // 初期ダミー
    const defaultItems = [
      { id: 1, content: '朝のルーチン', start: `${baseDate}T06:00:00`, end: `${baseDate}T07:00:00`, editable: true },
      { id: 2, content: '執筆',         start: `${baseDate}T09:00:00`, end: `${baseDate}T11:00:00`, editable: true },
      { id: 3, content: '昼休憩',       start: `${baseDate}T12:00:00`, end: `${baseDate}T13:00:00`, editable: true }
    ];

    // タイムラインのオプション
    const options = {
      editable: {
        add: false,  // ダブルクリックでの直接追加を無効化
        remove: true,
        updateTime: true,
        updateGroup: false,
        overrideItems: false
      },
      margin: { item: 10 },
      start: `${baseDate}T00:00:00`,
      end: `${baseDate}T24:00:00`,
      min: `${baseDate}T00:00:00`,
      max: `${baseDate}T24:00:00`,
      orientation: 'top',
      stack: false,
      snap: function (date, scale, step) {
        return Math.round(date / (15 * 60 * 1000)) * (15 * 60 * 1000); 
      },
      // 時間フォーマット設定
      format: {
        minorLabels: {
          hour: 'H時'
        },
        majorLabels: {
          hour: 'H時'
        }
      },
      onUpdate: function (item, callback) {
        callback(item);
        saveItem(item);
      },
      onRemove: function (item, callback) {
        callback(item);
        deleteItem(item.id);
      }
    };

    // 現在時刻を表す縦線を追加する関数
    function addCurrentTimeLine() {
      const now = new Date();
      const currentTime = new Date(`${baseDate}T${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:00`);
      
      // カスタムタイムラインに現在時刻を設定
      timeline.addCustomTime(currentTime, 'currentTime');
      timeline.setCustomTimeTitle('現在時刻', 'currentTime');
    }

    // 現在時刻ラインのスタイルを設定
    function styleCurrentTimeLine() {
      setTimeout(() => {
        const currentTimeLine = document.querySelector('.vis-custom-time.currentTime');
        if (currentTimeLine) {
          currentTimeLine.style.backgroundColor = '#ff0000';
          currentTimeLine.style.width = '2px';
          currentTimeLine.style.zIndex = '10';
        }
        
        // 現在時刻のテキストも赤色にする
        const currentTimeText = document.querySelector('.vis-custom-time.currentTime .vis-custom-time-text');
        if (currentTimeText) {
          currentTimeText.style.color = '#ff0000';
          currentTimeText.style.fontWeight = 'bold';
        }
      }, 100);
    }



    const items = new vis.DataSet([]);

    // タイムライン作成
    const container = document.getElementById('timeline');
    const timeline = new vis.Timeline(container, items, options);

    // 初期化関数
    async function initializeApp() {
      try {
        const savedItems = await loadItems();
        console.log('IndexedDBから読み込んだデータ:', savedItems);
        
        if (savedItems && savedItems.length > 0) {
          // 保存されたデータがある場合は読み込み
          items.add(savedItems);
          console.log('保存されたデータを読み込みました');
        } else {
          // 保存されたデータがない場合はデフォルトデータを使用
          items.add(defaultItems);
          // デフォルトデータも保存する
          for (const item of defaultItems) {
            await saveItem(item);
          }
          console.log('デフォルトデータを設定しました');
        }
      } catch (error) {
        console.error('初期化に失敗しました:', error);
        // エラーの場合はデフォルトデータを使用
        items.add(defaultItems);
      }
      addCurrentTimeLine();
      styleCurrentTimeLine();
    }

    // アプリケーション初期化
    window.addEventListener('load', function() {
      console.log('ページ読み込み完了');
      console.log('vis:', typeof vis);
      initializeApp();

      // 1分ごとに現在時刻ラインを更新
      setInterval(() => {
        const now = new Date();
        const currentTime = new Date(`${baseDate}T${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:00`);
        timeline.setCustomTime(currentTime, 'currentTime');
      }, 60000); // 60秒ごと
    });

    // アイテムダブルクリック時のリネーム機能（既存アイテム）
    timeline.on('doubleClick', function (props) {
      if (props.item) {
        // 既存アイテムのリネーム
        const item = items.get(props.item);
        showModal('アイテム名を変更してください', item.content, function(newName) {
          if (newName && newName.trim() !== '') {
            items.update({ id: props.item, content: newName.trim() });
            saveItem(items.get(props.item));
          }
        });
      } else if (props.time) {
        // 空いている場所での新規アイテム作成開始
        startNewItemCreation(props.time);
      }
    });

    // デバッグ用：現在のアイテム一覧を表示
    function showCurrentItems() {
      console.log('現在のアイテム一覧:', items.get());
    }

    // グローバルに公開（デバッグ用）
    window.showCurrentItems = showCurrentItems;
  </script>
</body>
</html>