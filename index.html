<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>1日の時間割タイムライン</title>
  <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
  <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #timeline { border: 1px solid #ccc; }
    /* 日付ラベル（曜日・月など）を非表示にする */
    .vis-time-axis .vis-text.vis-major {
      display: none !important;
    }
  </style>
</head>
<body>
  <h2>1日の時間割（ドラッグで変更可能）</h2>
  <div id="timeline"></div>

  <script>
    // 固定のダミー日付（どの日でもOK。時間だけ使う）
    const baseDate = "1970-01-01";

    // データベース初期化
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('timelineDB', 1);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('items')) {
            db.createObjectStore('items', { keyPath: 'id' });
          }
        };
        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
      });
    }

    // 保存
    async function saveItem(item) {
      const db = await openDB();
      const tx = db.transaction('items', 'readwrite');
      const store = tx.objectStore('items');
      store.put(item);
      return tx.complete;
    }

    // 削除
    async function deleteItem(id) {
      const db = await openDB();
      const tx = db.transaction('items', 'readwrite');
      const store = tx.objectStore('items');
      store.delete(id);
      return tx.complete;
    }

    // 取得
    async function loadItems() {
      const db = await openDB();
      const tx = db.transaction('items', 'readonly');
      const store = tx.objectStore('items');
      return new Promise((resolve, reject) => {
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    // 初期ダミー
    const defaultItems = [
      { id: 1, content: '朝のルーチン', start: `${baseDate}T06:00:00`, end: `${baseDate}T07:00:00`, editable: { updateTime: true } },
      { id: 2, content: '執筆',         start: `${baseDate}T09:00:00`, end: `${baseDate}T11:00:00`, editable: { updateTime: true } },
      { id: 3, content: '昼休憩',       start: `${baseDate}T12:00:00`, end: `${baseDate}T13:00:00`, editable: { updateTime: true } }
    ];

    // タイムラインのオプション
    const options = {
      editable: {
        add: true,       // バー追加
        remove: true,    // バー削除
        updateTime: true, // バー全体移動
        updateGroup: false,
        overrideItems: false
      },
      editable: true, // 全体的に編集可
      margin: { item: 10 },
      start: `${baseDate}T00:00:00`,
      end: `${baseDate}T24:00:00`,
      min: `${baseDate}T00:00:00`,
      max: `${baseDate}T24:00:00`,
      orientation: 'top',
      stack: false,
      snap: function (date, scale, step) {
        const hour = 60 * 60 * 1000; // 1時間（ミリ秒）
        return Math.round(date / (15 * 60 * 1000)) * (15 * 60 * 1000); 
        // ← 15分単位でスナップ
      },
    };

    // タイムライン作成
    const container = document.getElementById('timeline');
    const timeline = new vis.Timeline(container, items, options);

    // ページロード時に保存データをロード
    loadItems().then(savedItems => {
      if (savedItems.length) {
        items.add(savedItems);
      } else {
        items.add(defaultItems);
      }
    });

    // 変更イベント
    timeline.on('change', function(props) {
      props.items.forEach(async id => {
        const item = items.get(id);
        await saveItem(item);
      });
    });

    // 削除イベント
    timeline.on('remove', function(props) {
      props.items.forEach(async id => {
        await deleteItem(id);
      });
    });

    // 追加イベント：新規作成時に保存
    timeline.on('add', function(props) {
      const item = items.get(props.item);
      if (item) saveItem(item);
    });
    
    // 変更イベント
    timeline.on('change', function (props) {
      console.log('変更されたID:', props.items);
      console.log('新しいデータ:', items.get(props.items));
    });
  </script>
</body>
</html>
